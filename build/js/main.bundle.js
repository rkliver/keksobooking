(()=>{"use strict";const e=document.querySelector("#card").content.querySelector(".popup"),t="any",o=document.querySelector("#housing-type"),r=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),s=document.querySelector("#housing-guests"),a=document.querySelector("#housing-features"),c=e=>o.value===t||e.offer.type===o.value,l=e=>({any:e.offer.price,middle:e.offer.price>1e4&&e.offer.price<5e4,low:e.offer.price<1e4,high:e.offer.price>5e4}[r.value]),i=e=>n.value===t||String(e.offer.rooms)===n.value,d=e=>s.value===t||String(e.offer.guests)===s.value,u=e=>{const t=a.querySelectorAll("input:checked"),o=[];if(t.forEach((e=>o.push(e.value))),0===o.length)return!0;const r=e.offer;if(Object.keys(r).includes("features")){const e=r.features;return o.every((t=>e.includes(t)))}},p=document.querySelector(".ad-form"),f=document.querySelector(".map__filters"),y=L.map("map-canvas").on("load",(()=>{})).setView({lat:35.6895,lng:139.692},14);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(y);const h=L.icon({iconUrl:"/leaflet/img/main-pin.svg",iconSize:[40,40],iconAnchor:[20,52]}),m=L.marker({lat:35.6895,lng:139.692},{draggable:!0,icon:h});m.addTo(y),m.on("moveend",(e=>{let t=e.target.getLatLng().lat,o=e.target.getLatLng().lng;p.querySelector("#address").value=`${t.toFixed(5)}, ${o.toFixed(5)}`}));const g=_.debounce((v=t=>{let o=(e=>{const t=[];for(const o of e){if(t.length>=10)break;c(o)&&l(o)&&i(o)&&d(o)&&u(o)&&t.push(o)}return t})(t);const r=L.icon({iconUrl:"/leaflet/img/pin.svg",iconSize:[40,40],iconAnchor:[52,52]});o.forEach((t=>{{const o=L.marker({lat:t.location.lat,lng:t.location.lng},{icon:r});o.addTo(y).bindPopup((t=>{const o=e.cloneNode(!0);switch(o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь",t.offer.type){case"flat":o.querySelector(".popup__type").textContent="Квартира";break;case"bungalow":o.querySelector(".popup__type").textContent="Бунгало";break;case"house":o.querySelector(".popup__type").textContent="Дом";break;case"palace":o.querySelector(".popup__type").textContent="Дворец"}if(o.querySelector(".popup__text--capacity").textContent="Количество комнат: "+t.offer.rooms+" для "+t.offer.guests+" гостей",o.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout,o.querySelector(".popup__features").querySelectorAll(".popup__feature").forEach((e=>{e.remove()})),void 0!==t.offer.features)for(let e=0;e<t.offer.features.length;e++){let r=document.createElement("li");r.textContent=t.offer.features[e],r.classList.add("popup__feature","popup__feature--"+t.offer.features[e]),o.querySelector(".popup__features").appendChild(r)}if(o.querySelector(".popup__description").textContent=t.offer.description,o.querySelector(".popup__photos").querySelectorAll(".popup__photo").forEach((e=>{e.remove()})),void 0!==t.offer.photos)for(let e=0;e<t.offer.photos.length;e++){let r=document.createElement("img");r.src=t.offer.photos[e],r.classList.add("popup__photo"),r.width="45",r.height="40",r.alt="Фотография жилья",o.querySelector(".popup__photos").appendChild(r)}o.querySelector(".popup__avatar").src=t.author.avatar;for(let e=1;e<o.children.length;e++)""===o.children[e].textContent&&o.children[e].classList.add("hidden");return o})(t)),f.addEventListener("change",(()=>{o.remove()}))}}))},S=()=>(e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.position="absolute",t.style.left=0,t.style.top=0,t.style.right=0,t.style.padding="10px 3px",t.style.fontSize="30px",t.style.textAlign="center",t.style.backgroundColor="red",t.textContent="Произошла ошибка при загрузке данных с сервера",document.body.append(t),setTimeout((()=>{t.remove()}),1e4)})(),()=>fetch("https://26.javascript.pages.academy/keksobooking/data").then((e=>{if(e.ok)return e.json();throw new Error(`${e.status} ${e.statusText}`)})).then((e=>{v(e)})).catch((()=>{S()}))),500);var v,S;window.addEventListener("load",(()=>{g()})),f.addEventListener("change",(()=>{g()}));const q=["gif","jpg","jpeg","png"],C=document.querySelector("#avatar"),E=document.querySelector(".ad-form-header__preview").querySelector("img"),k=document.querySelector("#images"),w=document.querySelector(".ad-form__photo");w.style.columns="2",C.addEventListener("change",(()=>{const e=C.files[0],t=e.name.toLowerCase();if(q.some((e=>t.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{E.src=t.result})),t.readAsDataURL(e)}})),k.addEventListener("change",(()=>{const e=k.files[0],t=e.name.toLowerCase();if(q.some((e=>t.endsWith(e)))){const t=new FileReader;t.addEventListener("load",(()=>{const e=document.createElement("img");e.width=80,e.height=80,e.src=t.result,w.appendChild(e)})),t.readAsDataURL(e),w.children.length>9&&(k.setAttribute("disabled",!0),document.querySelector('label[for="images"]').textContent="Хватит =)")}}));const x=document.querySelector(".ad-form"),b=x.querySelector("#title"),V=x.querySelector("#type"),A=x.querySelector("#price"),T=x.querySelector("#timein"),O=x.querySelector("#timeout"),$=x.querySelector("#room_number"),j=x.querySelector("#capacity"),F=x.querySelector(".ad-form__reset"),z=document.querySelector("#success").content.cloneNode(!0),D=document.querySelector("#error").content.cloneNode(!0);x.appendChild(D),x.querySelector(".error").classList.add("hidden"),x.appendChild(z),x.querySelector(".success").classList.add("hidden");const N=V.options[0].cloneNode(!0);N.removeAttribute("selected"),N.innerText="Отель",N.value="hotel",V.insertBefore(N,V.options[2]),b.addEventListener("input",(()=>{const e=b.value.length;e<30?b.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?b.setCustomValidity("Удалите лишние "+(e-100)+" симв."):b.setCustomValidity(""),b.reportValidity()})),A.addEventListener("input",(()=>{A.value>1e6?A.setCustomValidity("Максимальное значение: 1000000"):A.setCustomValidity(""),A.reportValidity()})),j.addEventListener("input",(()=>{const e=$.selectedOptions[0].value,t=j.value;e<t&&"100"!==e?j.setCustomValidity("Количество гостей должно быть равным или меньшим, чем количество комнат"):"100"===e&&"0"!==t?j.setCustomValidity("В 100 комнат не войдет ни одного гостя =("):"100"!==e&&"0"===t?j.setCustomValidity("Совсем без гостей будет грустно"):j.setCustomValidity(""),j.reportValidity()})),V.addEventListener("input",(()=>{let e=0;switch(V.selectedOptions[0].value){case"flat":e=1e3;break;case"hotel":e=3e3;break;case"house":e=5e3;break;case"palace":e=1e4}return(e=>(A.placeholder=e,A.setAttribute("min",e),A))(e)})),T.addEventListener("input",(()=>(e=>{for(let t=0;t<O.options.length;t++)O.options[t].value==e&&(O.options[t].selected=!0);return O})(T.selectedOptions[0].value))),O.addEventListener("input",(()=>(e=>{for(let t=0;t<T.options.length;t++)T.options[t].value==e&&(T.options[t].selected=!0);return T})(O.selectedOptions[0].value)));const R=(e,t)=>{x.querySelector(`.${e}`).classList.toggle(`${t}`)};x.addEventListener("submit",(e=>{var t,o;e.preventDefault(),t=e=>{"Failed to fetch"===e&&(e="Сервис временно недоступен. Пожалуйста попробуйте ещё раз позже."),x.querySelector(".error__message").append(`. ${e}`),R("error","hidden"),x.querySelector(".error__button").addEventListener("click",(()=>{R("error","hidden")})),window.addEventListener("click",(()=>{x.querySelector(".error__message").innerText="Ошибка размещения объявления",x.querySelector(".error").classList.add("hidden")})),window.addEventListener("keydown",(e=>{"Escape"!==e.key&&"Esc"!==e.key||(x.querySelector(".error__message").innerText="Ошибка размещения объявления",x.querySelector(".error").classList.add("hidden"))}))},o=new FormData(e.target),fetch("https://26.javascript.pages.academy/keksobooking",{method:"POST",body:o}).then((e=>{e.ok?(R("success","hidden"),window.addEventListener("click",(()=>{x.querySelector(".success").classList.add("hidden")})),window.addEventListener("keydown",(e=>{"Escape"!==e.key&&"Esc"!==e.key||x.querySelector(".success").classList.add("hidden")})),x.reset(),E.src="img/muffin-grey.svg",w.textContent="",f.reset(),m._latlng.lat=35.6895,m._latlng.lng=139.692,m.update(),y.setView({lat:35.6895,lng:139.692},14),g()):t("Проверьте введённые данные.")})).catch((e=>{t(e.message)}))})),F.addEventListener("click",(e=>{e.preventDefault(),x.reset(),f.reset(),E.src="img/muffin-grey.svg",w.textContent="",m._latlng.lat=35.6895,m._latlng.lng=139.692,m.update(),y.setView({lat:35.6895,lng:139.692},14),g()}))})();
//# sourceMappingURL=main.bundle.js.map